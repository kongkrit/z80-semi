ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80 / R800)                          Page 1
Hexadecimal [32-Bits]



                                      1 ;====== custom crt0 for Z80+SDCC ======
                                      2 ; memory map:
                                      3 ; 0x0000-0x3fff ROM
                                      4 ; 0x4000-0xbfff RAM (must be empty of code/data)
                                      5 ; 0xC000-0xffff IO
                                      6 
                                      7     .globl  _main
                                      8 
                                      9 ; not playing with maskable interrupt in this class
                                     10 ;   .globl  _im1_handler    ; void func(void) __interrupt(1)
                                     11 
                                     12     .globl  _nmi_handler    ; void func(void) __critical __interrupt (bug fixed in sdcc 4.5+)
                                     13 
                                     14     ; Define in linker: -Wl-g_STACK_HIGH=0xC000
                                     15     .globl  _STACK_TOP
                                     16 
                                     17     ; Symbols generated by linker for copying initialized data
                                     18     .globl  l__INITIALIZER
                                     19     .globl  s__INITIALIZER
                                     20     .globl  s__INITIALIZED
                                     21 
                                     22 ; --- 1. Reset Vector (0x0000) ---
                                     23 .area   _HEADER (ABS)
    00000000                         24 .org    0x0000
    00000000 F3               [ 4]   25     di              ; Disable interrupts
                                     26     ; Z80 resets to Mode 0. We need Mode 1 for the 0x38 vector to work.
    00000001 ED 56            [ 8]   27     im      1
    00000003 31 00 01         [10]   28     ld      sp, #_STACK_TOP
    00000006 C3 70 00         [10]   29     jp      init
                                     30 
                                     31 ; --- 2. IM1 Vector (0x0038) ---
    00000038                         32 .org    0x0038
    00000038                         33 im1_vector:
    00000038 18 FE            [12]   34     jr      im1_vector  ; hangs until reset
                                     35     ; _im1_handler MUST use __interrupt(1) to generate 'reti'
                                     36 
                                     37 ; --- 3. NMI Vector (0x0066) ---
    00000066                         38 .org    0x0066
    00000066 C3 AA 00         [10]   39     jp      _nmi_handler  ; sdcc 4.5 returns from NMI with 'retn' correctly
                                     40 	                      ; we let sdcc handles all the register saves
                                     41 						  ; nmi_handler () __critical __interrupt   works with sdcc 4.5+
                                     42 
                                     43 ; --- 4. Initialization Code ---
                                     44 .area   _CODE
                                     45 
    00000070                         46 init:
                                     47     ; A. RAM Initialization (Copy ROM globals to RAM)
    00000070 01 00 00         [10]   48     ld      bc, #l__INITIALIZER
    00000073 78               [ 4]   49     ld      a, b
    00000074 B1               [ 4]   50     or      c
    00000075 28 08            [12]   51     jr      z, start_gsinit  ; Skip if 0 length
                                     52 
    00000077 11 C0 00         [10]   53     ld      de, #s__INITIALIZED
    0000007A 21 C0 00         [10]   54     ld      hl, #s__INITIALIZER
    0000007D ED B0            [21]   55     ldir                    ; Copy BC bytes from HL to DE
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80 / R800)                          Page 2
Hexadecimal [32-Bits]



                                     56 
    0000007F                         57 start_gsinit:
                                     58     ; B. Execute Global Constructors
    0000007F CD BF 00         [17]   59     call    gsinit
                                     60 
                                     61     ; C. Launch Main
                                     62     ; Enable interrupts before main if desired, otherwise do it inside main
                                     63     ; ei
    00000082 CD 87 00         [17]   64     call    _main
                                     65 
    00000085                         66 halt_loop:
    00000085 18 FE            [12]   67     jr      halt_loop
                                     68 
                                     69 ; --- 5. GSINIT Section ---
                                     70 .area   _GSINIT
    000000BF                         71 gsinit:
                                     72     ; SDCC fills this
                                     73 .area   _GSFINAL
    000000BF C9               [10]   74     ret
                                     75 
                                     76 ; --- 6. Ordering ---
                                     77     .area   _HOME
                                     78     .area   _CODE
                                     79     .area   _INITIALIZER
                                     80     .area   _GSINIT
                                     81     .area   _GSFINAL
                                     82     .area   _DATA
                                     83     .area   _INITIALIZED
                                     84     .area   _BSS
                                     85     .area   _HEAP
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80 / R800)                          Page 3
Hexadecimal [32-Bits]

Symbol Table

    .__.$$$.=   00002710 L   |     .__.ABS.=   00000000 G   |     .__.CPU.=   00000000 L
    .__.H$L.=   00000000 L   |     _STACK_T    ******** GX  |     _main       ******** GX
    _nmi_han    ******** GX  |   5 gsinit      00000000 R   |   0 halt_loo    00000015 R
  3 im1_vect    00000038 R   |   0 init        00000000 R   |     l__INITI    ******** GX
    s__INITI    ******** GX  |     s__INITI    ******** GX  |   0 start_gs    0000000F R

ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80 / R800)                          Page 4
Hexadecimal [32-Bits]

Area Table

   0 _CODE      size       17   flags    0
   1 _HEADER    size        0   flags    8
   2 _HEADER0   size        9   flags    8
   3 _HEADER1   size        2   flags    8
   4 _HEADER2   size        3   flags    8
   5 _GSINIT    size        0   flags    0
   6 _GSFINAL   size        1   flags    0
   7 _HOME      size        0   flags    0
   8 _INITIAL   size        0   flags    0
   9 _DATA      size        0   flags    0
   A _INITIAL   size        0   flags    0
   B _BSS       size        0   flags    0
   C _HEAP      size        0   flags    0

