;====== custom crt0 for Z80+SDCC ======
; memory map:
; 0x0000-0x3fff ROM
; 0x4000-0x7fff IO (must be empty of code/data)
; 0x8000-0xffff RAM

    .globl  _main
    .globl  _im1_handler    ; void func(void) __interrupt(1)
    .globl  _nmi_handler    ; void func(void) (Standard C function)

    ; Define in linker: -Wl-g_STACK_HIGH=0xFFFF
    .globl  _STACK_TOP

    ; Symbols generated by linker for copying initialized data
    .globl  l__INITIALIZER
    .globl  s__INITIALIZER
    .globl  s__INITIALIZED

; --- 1. Reset Vector (0x0000) ---
.area   _HEADER (ABS)
.org    0x0000
    di              ; Disable interrupts
    ; Z80 resets to Mode 0. We need Mode 1 for the 0x38 vector to work.
    im      1
    ld      sp, #_STACK_TOP
    jp      init

    ; Padding to 0x0038
    ;.ds     0x0038 - .

; --- 2. IM1 Vector (0x0038) ---
.org    0x0038
    jp      _im1_handler
    ; _im1_handler MUST use __interrupt(1) to generate 'reti'

    ; Padding to 0x0066
    ;.ds     0x0066 - .

; --- 3. NMI Vector (0x0066) ---
.org    0x0066
    jp      nmi_wrapper_asm

; --- 4. Initialization Code ---
.area   _CODE

nmi_wrapper_asm:
    ; 1. Save Main Registers
    push    af
    push    bc
    push    de
    push    hl
    push    iy
    push    ix

    ; 2. Swap to Shadow Set
    exx
    ex      af, af'

    ; 3. Save Shadow Registers (accessed via primary mnemonics now)
    push    af
    push    bc
    push    de
    push    hl

    ; 4. Call C handler
    call    _nmi_handler

    ; 5. Restore Shadow Registers
    pop     hl
    pop     de
    pop     bc
    pop     af

    ; 6. Swap back to Main Set
    ex      af, af'
    exx

    ; 7. Restore Main Registers
    pop     ix
    pop     iy
    pop     hl
    pop     de
    pop     bc
    pop     af

    retn    ; Return from NMI

init:
    ; A. RAM Initialization (Copy ROM globals to RAM)
    ld      bc, #l__INITIALIZER
    ld      a, b
    or      c
    jr      z, start_gsinit  ; Skip if 0 length

    ld      de, #s__INITIALIZED
    ld      hl, #s__INITIALIZER
    ldir                    ; Copy BC bytes from HL to DE

start_gsinit:
    ; B. Execute Global Constructors
    call    gsinit

    ; C. Launch Main
    ; Enable interrupts before main if desired, otherwise do it inside main
    ; ei
    call    _main

halt_loop:
    jr      halt_loop

; --- 5. GSINIT Section ---
.area   _GSINIT
gsinit:
    ; SDCC fills this
.area   _GSFINAL
    ret

; --- 6. Ordering ---
    .area   _HOME
    .area   _CODE
    .area   _INITIALIZER
    .area   _GSINIT
    .area   _GSFINAL
    .area   _DATA
    .area   _INITIALIZED
    .area   _BSS
    .area   _HEAP
