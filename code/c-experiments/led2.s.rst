ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80 / R800)                          Page 1
Hexadecimal [32-Bits]



                                      1 ;====== custom crt0 for Z80+SDCC ======
                                      2 ; memory map:
                                      3 ; 0x0000-0x3fff ROM
                                      4 ; 0x4000-0x7fff IO (must be empty of code/data)
                                      5 ; 0x8000-0xffff RAM
                                      6 
                                      7     .globl  _main
                                      8     .globl  _im1_handler    ; void func(void) __interrupt(1)
                                      9     .globl  _nmi_handler    ; void func(void) (Standard C function)
                                     10 
                                     11     ; Define in linker: -Wl-g_STACK_HIGH=0xFFFF
                                     12     .globl  _STACK_TOP
                                     13 
                                     14     ; Symbols generated by linker for copying initialized data
                                     15     .globl  l__INITIALIZER
                                     16     .globl  s__INITIALIZER
                                     17     .globl  s__INITIALIZED
                                     18 
                                     19 ; --- 1. Reset Vector (0x0000) ---
                                     20 .area   _HEADER (ABS)
    00000000                         21 .org    0x0000
    00000000 F3               [ 4]   22     di              ; Disable interrupts
                                     23     ; Z80 resets to Mode 0. We need Mode 1 for the 0x38 vector to work.
    00000001 ED 56            [ 8]   24     im      1
    00000003 31 00 01         [10]   25     ld      sp, #_STACK_TOP
    00000006 C3 8B 00         [10]   26     jp      init
                                     27 
                                     28     ; Padding to 0x0038
                                     29     ;.ds     0x0038 - .
                                     30 
                                     31 ; --- 2. IM1 Vector (0x0038) ---
    00000038                         32 .org    0x0038
    00000038 C3 CC 00         [10]   33     jp      _im1_handler
                                     34     ; _im1_handler MUST use __interrupt(1) to generate 'reti'
                                     35 
                                     36     ; Padding to 0x0066
                                     37     ;.ds     0x0066 - .
                                     38 
                                     39 ; --- 3. NMI Vector (0x0066) ---
    00000066                         40 .org    0x0066
    00000066 C3 6A 00         [10]   41     jp      nmi_wrapper_asm
                                     42 
                                     43 ; --- 4. Initialization Code ---
                                     44 .area   _CODE
                                     45 
    0000006A                         46 nmi_wrapper_asm:
                                     47     ; 1. Save Main Registers
    0000006A F5               [11]   48     push    af
    0000006B C5               [11]   49     push    bc
    0000006C D5               [11]   50     push    de
    0000006D E5               [11]   51     push    hl
    0000006E FD E5            [15]   52     push    iy
    00000070 DD E5            [15]   53     push    ix
                                     54 
                                     55     ; 2. Swap to Shadow Set
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80 / R800)                          Page 2
Hexadecimal [32-Bits]



    00000072 D9               [ 4]   56     exx
    00000073 08               [ 4]   57     ex      af, af'
                                     58 
                                     59     ; 3. Save Shadow Registers (accessed via primary mnemonics now)
    00000074 F5               [11]   60     push    af
    00000075 C5               [11]   61     push    bc
    00000076 D5               [11]   62     push    de
    00000077 E5               [11]   63     push    hl
                                     64 
                                     65     ; 4. Call C handler
    00000078 CD CF 00         [17]   66     call    _nmi_handler
                                     67 
                                     68     ; 5. Restore Shadow Registers
    0000007B E1               [10]   69     pop     hl
    0000007C D1               [10]   70     pop     de
    0000007D C1               [10]   71     pop     bc
    0000007E F1               [10]   72     pop     af
                                     73 
                                     74     ; 6. Swap back to Main Set
    0000007F 08               [ 4]   75     ex      af, af'
    00000080 D9               [ 4]   76     exx
                                     77 
                                     78     ; 7. Restore Main Registers
    00000081 DD E1            [14]   79     pop     ix
    00000083 FD E1            [14]   80     pop     iy
    00000085 E1               [10]   81     pop     hl
    00000086 D1               [10]   82     pop     de
    00000087 C1               [10]   83     pop     bc
    00000088 F1               [10]   84     pop     af
                                     85 
    00000089 ED 45            [14]   86     retn    ; Return from NMI
                                     87 
    0000008B                         88 init:
                                     89     ; A. RAM Initialization (Copy ROM globals to RAM)
    0000008B 01 00 00         [10]   90     ld      bc, #l__INITIALIZER
    0000008E 78               [ 4]   91     ld      a, b
    0000008F B1               [ 4]   92     or      c
    00000090 28 08            [12]   93     jr      z, start_gsinit  ; Skip if 0 length
                                     94 
    00000092 11 D8 00         [10]   95     ld      de, #s__INITIALIZED
    00000095 21 D1 00         [10]   96     ld      hl, #s__INITIALIZER
    00000098 ED B0            [21]   97     ldir                    ; Copy BC bytes from HL to DE
                                     98 
    0000009A                         99 start_gsinit:
                                    100     ; B. Execute Global Constructors
    0000009A CD D0 00         [17]  101     call    gsinit
                                    102 
                                    103     ; C. Launch Main
                                    104     ; Enable interrupts before main if desired, otherwise do it inside main
                                    105     ; ei
    0000009D CD B6 00         [17]  106     call    _main
                                    107 
    000000A0                        108 halt_loop:
    000000A0 18 FE            [12]  109     jr      halt_loop
                                    110 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80 / R800)                          Page 3
Hexadecimal [32-Bits]



                                    111 ; --- 5. GSINIT Section ---
                                    112 .area   _GSINIT
    000000D0                        113 gsinit:
                                    114     ; SDCC fills this
                                    115 .area   _GSFINAL
    000000D0 C9               [10]  116     ret
                                    117 
                                    118 ; --- 6. Ordering ---
                                    119     .area   _HOME
                                    120     .area   _CODE
                                    121     .area   _INITIALIZER
                                    122     .area   _GSINIT
                                    123     .area   _GSFINAL
                                    124     .area   _DATA
                                    125     .area   _INITIALIZED
                                    126     .area   _BSS
                                    127     .area   _HEAP
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80 / R800)                          Page 4
Hexadecimal [32-Bits]

Symbol Table

    .__.$$$.=   00002710 L   |     .__.ABS.=   00000000 G   |     .__.CPU.=   00000000 L
    .__.H$L.=   00000000 L   |     _STACK_T    ******** GX  |     _im1_han    ******** GX
    _main       ******** GX  |     _nmi_han    ******** GX  |   5 gsinit      00000000 R
  0 halt_loo    00000036 R   |   0 init        00000021 R   |     l__INITI    ******** GX
  0 nmi_wrap    00000000 R   |     s__INITI    ******** GX  |     s__INITI    ******** GX
  0 start_gs    00000030 R

ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80 / R800)                          Page 5
Hexadecimal [32-Bits]

Area Table

   0 _CODE      size       38   flags    0
   1 _HEADER    size        0   flags    8
   2 _HEADER0   size        9   flags    8
   3 _HEADER1   size        3   flags    8
   4 _HEADER2   size        3   flags    8
   5 _GSINIT    size        0   flags    0
   6 _GSFINAL   size        1   flags    0
   7 _HOME      size        0   flags    0
   8 _INITIAL   size        0   flags    0
   9 _DATA      size        0   flags    0
   A _INITIAL   size        0   flags    0
   B _BSS       size        0   flags    0
   C _HEAP      size        0   flags    0

